- name: Cài Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Cài Gunicorn
  pip:
    name: gunicorn
    executable: pip3

- name: Tạo systemd service cho gunicorn
  copy:
    dest: /etc/systemd/system/flask-app.service
    content: |
      [Unit]
      Description=Gunicorn instance to serve Flask app
      After=network.target

      [Service]
      User=www-data
      Group=www-data
      WorkingDirectory=/opt/flask-app
      EnvironmentFile=/opt/flask-app/.env
      ExecStart=/usr/local/bin/gunicorn --workers 3 --bind unix:/opt/flask-app/flask.sock app:app

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd và enable Flask
  shell: |
    systemctl daemon-reexec
    systemctl daemon-reload
    systemctl enable flask-app
    systemctl restart flask-app

- name: Cấu hình Nginx reverse proxy
  copy:
    dest: /etc/nginx/sites-available/flask-app
    content: |
      server {
          listen 80;
          server_name 10.0.2.6;

          location / {
              include proxy_params;
              proxy_pass http://unix:/opt/flask-app/flask.sock;
          }
      }

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/flask-app
    dest: /etc/nginx/sites-enabled/flask-app
    state: link
    force: yes

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Restart Nginx
  service:
    name: nginx
    state: restarted

